<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èª²ç¨‹è³‡æ–™ç®¡ç†å¾Œå° (å«è®€å–åŠŸèƒ½)</title>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; padding: 20px; background: #f0f2f5; }
        h2 { color: #333; }
        
        .controls { 
            margin-bottom: 20px; background: #fff; padding: 15px; 
            border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
            display: flex; gap: 10px; align-items: center; flex-wrap: wrap;
        }
        
        table { width: 100%; border-collapse: collapse; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 50px;}
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 14px; vertical-align: top;}
        th { background-color: #2c3e50; color: white; position: sticky; top: 0; z-index: 10; }
        
        input, select { width: 100%; padding: 5px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        
        .btn { padding: 8px 15px; cursor: pointer; border: none; border-radius: 4px; color: white; font-weight: bold; font-size: 14px; display: inline-flex; align-items: center; gap: 5px; }
        .btn-import { background-color: #6c757d; }
        .btn-add { background-color: #28a745; }
        .btn-save { background-color: #007bff; }
        .btn-del { background-color: #dc3545; padding: 5px 10px; font-size: 12px; }
        .btn:hover { opacity: 0.9; }

        .json-preview { margin-top: 20px; border-top: 1px solid #ccc; padding-top: 20px; }
        textarea { width: 100%; height: 150px; font-family: monospace; background: #333; color: #0f0; padding: 10px; border-radius: 5px; }
        
        /* éš±è—åŸæœ¬çš„æª”æ¡ˆä¸Šå‚³è¼¸å…¥æ¡†ï¼Œç”¨æŒ‰éˆ•è§¸ç™¼ */
        #fileInput { display: none; }
    </style>
</head>
<body>

    <h2>ğŸ› ï¸ è³‡å‚³ç³»èª²ç¨‹è¡¨ - è³‡æ–™ç®¡ç†å¾Œå°</h2>

    <div class="controls">
        <button class="btn btn-import" onclick="document.getElementById('fileInput').click()">ğŸ“‚ è®€å–èˆŠæª” (data.json)</button>
        <input type="file" id="fileInput" accept=".json" onchange="handleFileSelect(this)">
        
        <button class="btn btn-add" onclick="addNewRow()">+ æ–°å¢èª²ç¨‹</button>
        <button class="btn btn-save" onclick="downloadJSON()">â¬‡ï¸ ä¸‹è¼‰æ–°æª” (data.json)</button>
        
        <span style="color: #666; font-size: 0.9em; margin-left: auto;">
            æ“ä½œæ­¥é©Ÿï¼š1.è®€å–èˆŠæª” -> 2.ä¿®æ”¹ -> 3.ä¸‹è¼‰æ–°æª” -> 4.è¦†è“‹å°ˆæ¡ˆæª”æ¡ˆ
        </span>
    </div>

    <table id="editTable">
        <thead>
            <tr>
                <th width="8%">ä»£ç¢¼</th>
                <th width="15%">èª²ç¨‹åç¨±</th>
                <th width="12%">æ•™å¸« (å¤šäººç”¨ / åˆ†éš”)</th>
                <th width="5%">é€±</th>
                <th width="8%">ç¯€æ¬¡ (é€—è™Ÿéš”é–‹)</th>
                <th width="8%">æ•™å®¤</th>
                <th width="5%">å¹´ç´š</th>
                <th width="6%">ç­ç´šé¡åˆ¥</th>
                <th width="5%">å¿…ä¿®</th>
                <th width="8%">é¡¯ç¤ºç­ç´š</th>
                <th width="5%">æ“ä½œ</th>
            </tr>
        </thead>
        <tbody id="tbody">
            </tbody>
    </table>

    <div class="json-preview">
        <h3>JSON è³‡æ–™é è¦½ (è‡ªå‹•ç”Ÿæˆ)</h3>
        <textarea id="jsonOutput" readonly></textarea>
    </div>

    <script>
        // åˆå§‹ç©ºè³‡æ–™çµæ§‹
        let currentData = {
            "metadata": { "semester": "113-1", "department": "è³‡å‚³ç³»" },
            "timeSlots": [
                { "period": "1", "time": "08:10<br>~<br>09:00" },
                { "period": "2", "time": "09:10<br>~<br>10:00" },
                { "period": "3", "time": "10:10<br>~<br>11:00" },
                { "period": "4", "time": "11:10<br>~<br>12:00" },
                { "period": "5", "time": "12:10<br>~<br>13:00", "isLunch": true },
                { "period": "6", "time": "13:10<br>~<br>14:00" },
                { "period": "7", "time": "14:10<br>~<br>15:00" },
                { "period": "8", "time": "15:10<br>~<br>16:00" },
                { "period": "9", "time": "16:10<br>~<br>17:00" },
                { "period": "10", "time": "17:10<br>~<br>18:00" },
                { "period": "12-14", "time": "19:10<br>~<br>22:00" }
            ],
            "courses": [] 
        };

        // åˆå§‹åŒ–
        function init() {
            renderTable();
            updatePreview();
        }

        // ==========================================
        // 1. æª”æ¡ˆè®€å–åŠŸèƒ½ (File Reader)
        // ==========================================
        function handleFileSelect(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    // è§£æè®€å–åˆ°çš„ JSON
                    const jsonResult = JSON.parse(e.target.result);
                    
                    // æ›´æ–°ç›®å‰çš„è³‡æ–™
                    currentData = jsonResult;
                    
                    // é‡æ–°æ¸²æŸ“ç•«é¢
                    renderTable();
                    updatePreview();
                    
                    alert("âœ… è®€å–æˆåŠŸï¼å…±è¼‰å…¥ " + currentData.courses.length + " ç­†èª²ç¨‹ã€‚");
                } catch (error) {
                    alert("âŒ è®€å–å¤±æ•—ï¼šæª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼Œè«‹ç¢ºèªæ˜¯æœ‰æ•ˆçš„ JSON æª”ã€‚\n" + error);
                }
            };
            
            reader.readAsText(file);
            // æ¸…ç©º input è®“åŒä¸€æª”æ¡ˆå¯é‡è¤‡é¸å–
            input.value = ''; 
        }

        // ==========================================
        // 2. è¡¨æ ¼æ¸²æŸ“ (Render)
        // ==========================================
        function renderTable() {
            const tbody = document.getElementById('tbody');
            tbody.innerHTML = '';

            // æŒ‰ç…§é€±æ¬¡èˆ‡ç¯€æ¬¡ç°¡å–®æ’åºï¼Œæ–¹ä¾¿é–±è®€
            currentData.courses.sort((a, b) => {
                if (a.day !== b.day) return a.day - b.day;
                return parseInt(a.periods[0]) - parseInt(b.periods[0]);
            });

            currentData.courses.forEach((course, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><input type="text" value="${course.code || ''}" onchange="updateData(${index}, 'code', this.value)"></td>
                    <td><input type="text" value="${course.name}" onchange="updateData(${index}, 'name', this.value)"></td>
                    <td><input type="text" value="${course.teacher}" onchange="updateData(${index}, 'teacher', this.value)"></td>
                    <td><input type="number" min="1" max="5" value="${course.day}" onchange="updateData(${index}, 'day', parseInt(this.value))"></td>
                    <td><input type="text" value="${course.periods.join(',')}" onchange="updatePeriods(${index}, this.value)"></td>
                    <td><input type="text" value="${course.room}" onchange="updateData(${index}, 'room', this.value)"></td>
                    <td><input type="text" value="${course.year}" onchange="updateData(${index}, 'year', this.value)"></td>
                    <td>
                        <select onchange="updateData(${index}, 'classType', this.value)">
                            <option value="a" ${course.classType === 'a' ? 'selected' : ''}>ç”² (a)</option>
                            <option value="b" ${course.classType === 'b' ? 'selected' : ''}>ä¹™ (b)</option>
                            <option value="common" ${course.classType === 'common' ? 'selected' : ''}>å…± (common)</option>
                        </select>
                    </td>
                    <td>
                        <select onchange="updateData(${index}, 'required', this.value === 'true')">
                            <option value="true" ${course.required ? 'selected' : ''}>æ˜¯</option>
                            <option value="false" ${!course.required ? 'selected' : ''}>å¦</option>
                        </select>
                    </td>
                    <td><input type="text" value="${course.className}" onchange="updateData(${index}, 'className', this.value)"></td>
                    <td style="text-align:center;"><button class="btn btn-del" onclick="deleteRow(${index})">åˆªé™¤</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        // ==========================================
        // 3. è³‡æ–™æ›´æ–°é‚è¼¯
        // ==========================================
        window.updateData = function(index, field, value) {
            currentData.courses[index][field] = value;
            updatePreview();
        };

        window.updatePeriods = function(index, value) {
            const arr = value.split(',').map(s => s.trim());
            currentData.courses[index].periods = arr;
            updatePreview();
        };

        window.addNewRow = function() {
            // æ–°å¢ä¸€ç­†é è¨­è³‡æ–™
            currentData.courses.unshift({
                code: "NEW", name: "æ–°èª²ç¨‹", teacher: "è€å¸«", day: 1, periods: ["1"], room: "æ•™å®¤", year: "1", classType: "common", required: false, className: "å¤§ä¸€"
            });
            renderTable();
            updatePreview();
        };

        window.deleteRow = function(index) {
            if(confirm("ç¢ºå®šè¦åˆªé™¤é€™å ‚èª²å—ï¼Ÿ")) {
                currentData.courses.splice(index, 1);
                renderTable();
                updatePreview();
            }
        };

        // æ›´æ–° JSON é è¦½å€å¡Š
        function updatePreview() {
            document.getElementById('jsonOutput').value = JSON.stringify(currentData, null, 2);
        }

        // ==========================================
        // 4. ä¸‹è¼‰åŠŸèƒ½
        // ==========================================
        window.downloadJSON = function() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(document.getElementById('jsonOutput').value);
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "data.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        };

        init();
    </script>
</body>
</html>
